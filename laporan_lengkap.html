<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Laporan Lengkap</title>

<style>
body{margin:0;font-family:Arial;background:#f4f6f9}
header{background:#1e90ff;color:#fff;padding:12px;display:flex;justify-content:space-between}
.container{padding:12px}
.card{
 background:#fff;padding:12px;border-radius:10px;margin-bottom:10px;
 box-shadow:0 2px 6px rgba(0,0,0,.15)
}
.grid{
 display:grid;
 grid-template-columns:repeat(2,1fr);
 gap:10px;
 margin-bottom:15px
}
.box{
 background:#fff;padding:12px;border-radius:10px;font-weight:bold
}
table{width:100%;border-collapse:collapse;background:#fff}
th{background:#eef2f7;padding:8px}
td{padding:8px;border-bottom:1px solid #eee;text-align:center}

 header button{
  background:white;
  color:red;
  border:none;
  padding:6px 12px;
  border-radius:6px;
  cursor:pointer;
  font-weight:bold;
}
 
 </style>
</head>

<body>

<header>
<h3>ðŸ“Š Laporan Lengkap</h3>
  <div>
    <button onclick="location.href='dashboard.html'">dashboard</button>
    <button onclick="location.href='dashboard_laporan.html'">back</button>
  </div>
</header>

<div class="container">

<div class="grid">
 <div class="box">ðŸ‘¥ Anggota<br><span id="jAnggota">0</span></div>
 <div class="box">ðŸ’° Simpanan<br><span id="tSimpanan">Rp 0</span></div>
 <div class="box">ðŸ’³ Pinjaman<br><span id="tPinjaman">Rp 0</span></div>
 <div class="box">ðŸ“‰ Sisa Pinjaman<br><span id="sPinjaman">Rp 0</span></div>
 <div class="box">ðŸ’µ Total Angsuran<br><span id="tAngsuran">Rp 0</span></div>
</div>

<div class="card">
Kas Masuk : <b id="masuk">Rp 0</b><br>
Kas Keluar : <b id="keluar">Rp 0</b><br>
Saldo Kas : <b id="saldo">Rp 0</b>
</div>
 <button onclick="exportPDF()">ðŸ“„ Preview PDF</button>
<button onclick="kirimWA()">ðŸ“¤ Kirim ke WhatsApp</button>
<br><br>
<table>
<thead>
<tr>
<th>Tanggal</th>
<th>Keterangan</th>
<th>Masuk</th>
<th>Keluar</th>
</tr>
</thead>
<tbody id="list"></tbody>
</table>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="js/storage.js"></script>
<script>
function rupiah(n){
 return "Rp "+Number(n||0).toLocaleString("id-ID");
}

function loadLaporan(){

 const db = getDB();

 db.anggota ??= [];
 db.simpanan ??= [];
 db.pinjaman ??= [];
 db.kas ??= [];

 document.getElementById("jAnggota").innerText = db.anggota.length;

 /* =====================
    SIMPANAN / PINJAMAN / ANGSURAN
 ===================== */

 let tS = 0; // simpanan
 let tP = 0; // pinjaman cair
 let sP = 0; // sisa pinjaman
 let tA = 0; // total angsuran

 db.simpanan.forEach(s=>{
  tS += Number(s.jumlah||0);
 });

 db.pinjaman.forEach(p=>{
  sP += Number(p.sisa||0);
 });

 db.kas.forEach(k=>{

  // pencairan pinjaman
  if(k.jenis==="KELUAR" && k.keterangan.includes("Pinjaman")){
   tP += Number(k.jumlah||0);
  }

  // angsuran masuk
  if(k.jenis==="MASUK" && k.keterangan.includes("Angsuran")){
   tA += Number(k.jumlah||0);
  }

 });

 document.getElementById("tSimpanan").innerText = rupiah(tS);
 document.getElementById("tPinjaman").innerText = rupiah(tP);
 document.getElementById("sPinjaman").innerText = rupiah(sP);
 document.getElementById("tAngsuran").innerText = rupiah(tA);

 /* =====================
    KAS
 ===================== */

 let masuk = 0;
 let keluar = 0;
 list.innerHTML = "";

 db.kas.sort((a,b)=>a.tanggal.localeCompare(b.tanggal));

 db.kas.forEach(k=>{

  if(k.jenis==="MASUK") masuk += Number(k.jumlah||0);
  if(k.jenis==="KELUAR") keluar += Number(k.jumlah||0);

  list.innerHTML += `
   <tr>
    <td>${k.tanggal}</td>
    <td>${k.keterangan}</td>
    <td>${k.jenis==="MASUK"?rupiah(k.jumlah):"-"}</td>
    <td>${k.jenis==="KELUAR"?rupiah(k.jumlah):"-"}</td>
   </tr>`;
 });

 document.getElementById("masuk").innerText = rupiah(masuk);
 document.getElementById("keluar").innerText = rupiah(keluar);
 document.getElementById("saldo").innerText = rupiah(masuk-keluar);
}
 
 function tanggalIndo(){
 const d = new Date();
 return d.toLocaleDateString("id-ID",{
  day:"2-digit",
  month:"long",
  year:"numeric"
 });
}
 function tanggalFile(){
 const d = new Date();
 return d.toISOString().slice(0,10); // 2026-02-10
}
 function exportPDF(){

 const { jsPDF } = window.jspdf;
 const doc = new jsPDF();

 const db = getDB();
 db.kas ??= [];

 doc.setFontSize(14);
 doc.text("LAPORAN KAS",14,15);

 doc.setFontSize(10);
 doc.text("Koperasi DRIVER KHALIFA",14,22);
 doc.text("Tanggal : " + tanggalIndo(),14,28);

 let body = [];
 let totalMasuk = 0;
 let totalKeluar = 0;

 db.kas.forEach(k=>{
  const masuk = k.jenis==="MASUK" ? Number(k.jumlah||0) : 0;
  const keluar = k.jenis==="KELUAR" ? Number(k.jumlah||0) : 0;

  totalMasuk += masuk;
  totalKeluar += keluar;

  body.push([
   k.tanggal || "-",
   k.keterangan || "-",
   masuk ? rupiah(masuk) : "-",
   keluar ? rupiah(keluar) : "-"
  ]);
 });

 doc.autoTable({
  startY:32,
  head:[["Tanggal","Keterangan","Masuk","Keluar"]],
  body: body.length ? body : [["-","Belum ada data","-","-"]],
  styles:{fontSize:9},
  headStyles:{fillColor:[30,144,255]}
 });

 const y = doc.lastAutoTable.finalY + 8;
 doc.text(`Total Masuk  : ${rupiah(totalMasuk)}`,14,y);
 doc.text(`Total Keluar : ${rupiah(totalKeluar)}`,14,y+6);
 doc.text(`Saldo        : ${rupiah(totalMasuk-totalKeluar)}`,14,y+12);

 // SIMPAN UNTUK SHARE
 window.pdfKas = doc;

 // âœ… PREVIEW PALING AMAN
 const blobUrl = doc.output("bloburl");
 window.open(blobUrl, "_blank");
}
 
 function kirimWA(){
 if(!window.pdfKas){
  alert("Preview PDF dulu");
  return;
 }

  const namaFile = "Laporan_Kas_"+tanggalFile()+".pdf";
 const pdfBlob = window.pdfKas.output("blob");

 const file = new File([pdfBlob], namaFile, {
  type:"application/pdf"
 });

 if(navigator.share){
  navigator.share({
   title:"Laporan Kas",
   text:"Laporan kas koperasi",
   files:[file]
  });
 }else{
  alert("Share tidak didukung di perangkat ini");
 }
}

 document.addEventListener("DOMContentLoaded", loadLaporan);

 </script>

</body>
</html>